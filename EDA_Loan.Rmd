---
title: "Prosper Loan Data Analysis"
author: "Mayukh Sarkar"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
---

## Loading the packages
```{r}
suppressMessages(library(ggplot2))
suppressMessages(library(ggthemes))
suppressMessages(library(dplyr))
suppressMessages(library(reshape2))
suppressMessages(library(memisc))
suppressMessages(library(gridExtra))
suppressMessages(library(RColorBrewer))
suppressMessages(library(magrittr))
```

## Loading the dataset
```{r}
loanData <- read.csv('prosperLoanData.csv')
```

## The first Qustion
The first question that needs to be asked is HOW LONG PEOPLE USUALLY OPT FOR LOAN? Let's answer this question with a histogram
```{r}
loanData %>% 
    ggplot(aes(x = Term / 12)) +
        geom_histogram(binwidth = 1) +
        theme_pander() + 
        xlab('Term in Years') +
        ylab('How many?') + 
        scale_x_continuous(breaks = seq(1, 5, 2))
```

We can see that people don't really loan any amount for less than one year and the most popular loan amount is of 3 years although some people do choose for 5 years. Now lets assume something and check if it is correct or not. I assume that people who opted for 1 year would fail to repay their loan more as compared to the people who opeted for 3 or 5 years. But is it true? So the next question is
DOES PEOPLE REPAY THE LOANS BETTER WHEN THEY ARE GIVEN MORE TIME?
```{r}
totalLoanTermes <- loanData %>%
    group_by(Term) %>%
    summarise(n = n()) %>%
    use_series(n)
totalLoanTermes <- rep(totalLoanTermes, each = 2)
loanData.two_status <- loanData %>%
    group_by(Term, LoanStatus) %>%
    summarise(n = n()) %>%
    filter(LoanStatus == 'Completed' | LoanStatus == 'Defaulted')
loanData.two_status$percent = (loanData.two_status$n / totalLoanTermes) * 100
```
Now let's plot the data
```{r}
ggplot(aes(x = Term / 12, y = percent, fill = LoanStatus), data = loanData.two_status) +
    geom_bar(stat = 'identity', position="dodge", color = 'black') + 
    scale_x_continuous(breaks = c(1, 3, 5)) +
    xlab('Loan term in years') + 
    theme_pander() +
    coord_flip()
```

That's unusual because for **LoanStatus** of _Completed_, we see a trend but not in **LoanStatus** of _Defaulted_ though. Now just because some customer's loan status is not Completed, doesn't mean his/her loan status is Defaulted.
The reason we are exploring this is because we want to find if BANKS SHOULD FOCUS ON CUSTOMERS OPTING LOANS FOR SMALLER TERMS OR NOT? For this getting data of only two loan status won't be enough. So let's divide the customers into two groups

    1. Good Customer
    2. Bad Customer


## The bigger picture
```{r}
loanData.gb <- loanData %>%
    group_by(Term, LoanStatus) %>%
    summarise(n = n()) %>%
    mutate(customer_type = ifelse((LoanStatus == 'Current' | 
                                   LoanStatus == 'Completed'| 
                                   LoanStatus == 'FinalPaymentInProgress'),
                                  'good', 'bad')) %>%
    filter(LoanStatus != 'Cancelled') %>%
    mutate(freq = n / sum(n) * 100) %>%
    ungroup() %>%
    group_by(Term, customer_type) %>%
    summarise(n = sum(freq))
```
## Plotting the trend of different customer types
```{r}
ggplot(aes(x = Term / 12, y = n, fill = customer_type), data = loanData.gb) +
    geom_bar(stat = 'identity', position="dodge") + 
    theme_pander() +
    xlab('Loan term in years') +
    ylab('Percentage') +
    scale_x_continuous(breaks = c(1, 3, 5)) +
    geom_text(aes(label = sprintf("%2.1f%%", round(n, 2)), vjust = -.5), color="black") +
    facet_wrap(~customer_type) +
    scale_fill_hc()
```
As we can that the short and long term prospects of the banks who issues the loan seeems gppd because both in 1 and 5 year category, we see more number of good customers as compared to the 3 years. The number of good customers is however decreased a little from 1 year to 5 years but as compared to 3 years it is nothing. This may mean that banks should focus in long and short term customers as compared to medium term customers. But we should take this fact with a grain of slat because there might be other factors that may affect this trend. Only further exploration of the data would reveal that.

## EstimatedEffectiveYield - A better measure for a successful Lender
```{r}
ggplot(aes(x = EstimatedEffectiveYield), data = loanData) +
    geom_histogram(aes(y = ..density..), bins = 100, na.rm = T, 
                   color = 'darkblue', fill = 'lightblue') +
    theme_hc() +
    scale_x_continuous(limits = c(-0.1827, 0.3199), 
                       breaks = seq(-0.1827, 0.3199, 0.05)) +
    geom_density(alpha=.2, fill="#FF6666", na.rm = T) + 
    geom_vline(aes(xintercept=mean(EstimatedEffectiveYield, na.rm=T)), 
               color="blue", linetype="dashed", size=1)
```

**EstimatedEffectiveYield** is said to be better estimate for the lenders than the interest rate because the interest includes _processing fees_, _uncollected interest due to borrower being chargedoff_. Plus it also doesn;t include _late fines_. Hence EstimatedEffectiveYield takes account for all these things and it is thus a better measure. Above we are trying to see the ditribution of the EstimatedEffectiveYield and we can see that it is multimodal. We see the most popular EstimatedEffectiveYield is around 0.3 while the mean is around 0.17 represented by the blue dotted line. The multimodal pattern shows that there are multiple EstimatedEffectiveYield that is popular. Strangely we can also see that the some customers have negative EstimatedEffectiveYield. This may mean a lot of things. This may mean that their BorrowerRate is a lot lower than their _service fee rate_ or these customer's _uncollected interest on chargeoff_ is lot more or they just never payed the late fee and payed back the loans along with the interest always on time.

Now lets see what is the distrubution of EstimatedEffectiveYield depending on the different **ProsperScore**. This is important because we want to answer a question, i.e., IF LENDERS GET MORE EstimatedEffectiveYield IF THEY HAVE BETTER ProsperScore ?

We are using violin plot instead of box plot for this.

```{r}
loanData$ProsperScore <- factor(loanData$ProsperScore)
ggplot(aes(x = ProsperScore, y = EstimatedEffectiveYield, fill=ProsperScore), 
       data = subset(loanData, !is.na(ProsperScore) & !is.na(EstimatedEffectiveYield))) +
    geom_violin(trim = F, scale = "width") +
    stat_summary(fun.y=median, geom="point", size=2, color="black") +
    scale_fill_manual(values=colorRampPalette(c("pink", "lightgreen"))(11)) + 
    theme_minimal() +
    xlab('\nScore for Risk Factor') +
    ylab('Effective yeild of Lenders')
```
